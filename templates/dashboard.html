{% extends "base.html" %}
{% block content %}
<div class="row g-3">
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5>Users</h5>
        <div class="display-6">{{ users_count }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5>Encodings</h5>
        <div class="display-6">{{ enc_count }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5>Logs</h5>
        <div class="display-6">{{ logs_count }}</div>
      </div>
    </div>
  </div>
</div>

<!-- Camera Stream -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Live Camera Stream</h5>
        <div>
          <button id="startStream" class="btn btn-success btn-sm me-2">Start Stream</button>
          <button id="stopStream" class="btn btn-danger btn-sm" disabled>Stop Stream</button>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <div class="position-relative">
              <!-- Main MJPEG stream -->
              <img id="videoStream" src="" alt="Camera feed" 
                   class="img-fluid rounded" 
                   style="width: 100%; min-height: 300px; background-color: #f8f9fa;">
              <div id="streamStatus" class="position-absolute top-0 end-0 m-2">
                <span class="badge bg-secondary">Not Connected</span>
              </div>
            </div>
            
            <div class="mt-3">
              <label class="form-label">Stream URL</label>
              <div class="input-group input-group-sm">
                <input type="text" id="streamUrl" class="form-control" 
                       value="/camera/stream">
                <button class="btn btn-outline-secondary" type="button" id="updateUrl">Update</button>
              </div>
              <div class="form-text">
                Default ESP32-CAM stream URL: <code>http://[ESP_IP]:81/stream</code>
              </div>
            </div>
          </div>
          
          <!-- Stream Info -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">Stream Info</h6>
              </div>
              <div class="card-body">
                <div class="mb-2">
                  <strong>Status:</strong> <span id="connectionStatus">Disconnected</span>
                </div>
                <div class="mb-2">
                  <strong>Last Updated:</strong> <span id="lastUpdate">Never</span>
                </div>
                <div class="mb-2">
                  <strong>Frame Count:</strong> <span id="frameCount">0</span>
                </div>
                <div class="mb-3">
                  <strong>Errors:</strong> <span id="errorCount">0</span>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">Frame Rate: <span id="fpsValue">10</span> FPS</label>
                  <input type="range" class="form-range" id="fpsSlider" min="1" max="30" value="10">
                </div>
                
                <div class="d-grid">
                  <button id="captureFrame" class="btn btn-primary btn-sm">Capture Frame</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Logs -->
<h4 class="mt-4">Recent Events</h4>
<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr><th>When</th><th>Status</th><th>Name</th><th>Reason/Distance</th><th>Capture</th></tr>
    </thead>
    <tbody id="recent-logs">
      {% for r in recent %}
      <tr>
        <td>{{ r["ts"] }}</td>
        <td>
          {% if r["status"] == "granted" %}
          <span class="badge text-bg-success">granted</span>
          {% else %}
          <span class="badge text-bg-danger">denied</span>
          {% endif %}
        </td>
        <td>{{ r["name"] }}</td>
        <td>{{ r["reason"] or "" }}</td>
        <td>
          {% if r["image_path"] %}
          <img src="/captures/{{ r['image_path'] }}" alt="" 
               style="height:60px;border-radius:6px;">
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- inside your dashboard.html, replace the previous <script>...</script> block with this -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const videoStream = document.getElementById('videoStream');
  const startBtn = document.getElementById('startStream');
  const stopBtn = document.getElementById('stopStream');
  const streamStatus = document.getElementById('streamStatus');
  const connectionStatus = document.getElementById('connectionStatus');
  const lastUpdate = document.getElementById('lastUpdate');
  const frameCount = document.getElementById('frameCount');
  const errorCount = document.getElementById('errorCount');
  const streamUrl = document.getElementById('streamUrl');
  const updateUrlBtn = document.getElementById('updateUrl');
  const fpsSlider = document.getElementById('fpsSlider');
  const fpsValue = document.getElementById('fpsValue');
  const captureFrameBtn = document.getElementById('captureFrame');

  // default to proxied stream
  if (!streamUrl.value) streamUrl.value = '/camera/stream';

  let streamInterval = null;
  let currentFps = parseInt(fpsSlider.value || 10);
  let framesReceived = 0;
  let errors = 0;
  let lastFrameTime = 0;

  fpsSlider.addEventListener('input', function() {
    currentFps = parseInt(this.value);
    fpsValue.textContent = currentFps;
    if (streamInterval) {
      stopStream();
      startStream();
    }
  });

  updateUrlBtn.addEventListener('click', function() {
    if (streamInterval) {
      stopStream();
      startStream();
    }
  });

  startBtn.addEventListener('click', startStream);
  stopBtn.addEventListener('click', stopStream);

  // capture snapshot via the server endpoint (more reliable than reading the <img> src)
  captureFrameBtn.addEventListener('click', async function() {
    captureFrameBtn.disabled = true;
    captureFrameBtn.innerHTML = 'Capturing...';
    try {
      const r = await fetch('/camera/snapshot');
      if (!r.ok) throw new Error('Snapshot failed: ' + r.status);
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);

      // show quick preview in a new tab and trigger download
      const a = document.createElement('a');
      a.href = url;
      a.download = 'snapshot-' + new Date().toISOString().replace(/:/g, '-') + '.jpg';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (err) {
      alert('Snapshot error: ' + err.message);
    } finally {
      captureFrameBtn.disabled = false;
      captureFrameBtn.innerHTML = 'Capture Frame';
    }
  });

  function startStream() {
    if (streamInterval) clearInterval(streamInterval);
    startBtn.disabled = true;
    stopBtn.disabled = false;
    streamStatus.innerHTML = '<span class="badge bg-success">Connected</span>';
    connectionStatus.textContent = 'Connecting...';

    const url = streamUrl.value + '?cache=' + Date.now();
    videoStream.src = url;

    const intervalMs = Math.round(1000 / currentFps);
    streamInterval = setInterval(updateStream, intervalMs);

    framesReceived = 0;
    errors = 0;
    updateCounters();
  }

  function stopStream() {
    if (streamInterval) {
      clearInterval(streamInterval);
      streamInterval = null;
    }
    startBtn.disabled = false;
    stopBtn.disabled = true;
    streamStatus.innerHTML = '<span class="badge bg-secondary">Not Connected</span>';
    connectionStatus.textContent = 'Disconnected';
    videoStream.src = '';
  }

  function updateStream() {
    // For proxied MJPEG the browser will stream continuously via the <img> element.
    // However changing img.src periodically helps 'refresh' if the camera or proxy buffers
    // stale frames. We use a cache-buster timestamp.
    const now = Date.now();
    try {
      videoStream.src = streamUrl.value + (streamUrl.value.indexOf('?') === -1 ? '?' : '&') + 't=' + now;
      framesReceived++;
      lastFrameTime = new Date();
      updateCounters();
    } catch (e) {
      errors++;
      updateCounters();
    }
  }

  function updateCounters() {
    frameCount.textContent = framesReceived;
    errorCount.textContent = errors;
    if (lastFrameTime) {
      lastUpdate.textContent = lastFrameTime.toLocaleTimeString();
    }
    const now = new Date();
    if (lastFrameTime && (now - lastFrameTime) > 3000) {
      connectionStatus.textContent = 'Lagging';
      streamStatus.innerHTML = '<span class="badge bg-warning">Lagging</span>';
    } else if (lastFrameTime) {
      connectionStatus.textContent = 'Connected';
      streamStatus.innerHTML = '<span class="badge bg-success">Connected</span>';
    }
  }

  videoStream.addEventListener('error', function() {
    errors++;
    updateCounters();
    if (errors > 5 && streamInterval) {
      stopStream();
      setTimeout(startStream, 2000);
    }
  });

  videoStream.addEventListener('load', function() {
    connectionStatus.textContent = 'Connected';
    lastFrameTime = new Date();
    updateCounters();
  });
});
</script>

{% endblock %}
